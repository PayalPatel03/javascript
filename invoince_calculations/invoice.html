<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Invoice with Calculation</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      :root{--card-radius:1rem}
      body{background:#f4f7fb;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
      .card{border-radius:var(--card-radius)}
      .item-row .form-control{min-width:0}
      .table thead th{vertical-align:middle}
      .muted-small{font-size:.85rem;color:#6c757d}
      @media (max-width:767px){
        .desktop-only{display:none}
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="row g-4">
        <div class="col-12">
          <h1 class="mb-1">Invoice — With Calculation</h1>
          <p class="muted-small">Create an invoice, add items, apply discounts/taxes and print or save.</p>
        </div>

        <!-- Input / Form Card -->
        <div class="col-lg-6">
          <div class="card shadow-sm p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="m-0">Add Items</h5>
              <div>
                <button id="btnReset" class="btn btn-sm btn-outline-danger me-2">Reset All</button>
                <button id="btnSaveLocal" class="btn btn-sm btn-outline-primary">Save Invoice</button>
              </div>
            </div>

            <form id="invoiceForm" novalidate>
              <div id="itemsContainer">
                <!-- item rows injected here -->
              </div>

              <div class="d-flex gap-2 mt-3">
                <button id="addItemBtn" type="button" class="btn btn-success">+ Add Item</button>
                <button id="calcBtn" type="button" class="btn btn-primary">Recalculate</button>
                <button id="printBtn" type="button" class="btn btn-outline-secondary ms-auto">Print Invoice</button>
              </div>

              <hr class="my-3">

              <div class="row g-2 align-items-center">
                <div class="col-6">
                  <label class="form-label">Tax (percentage)</label>
                  <input id="taxInput" type="number" min="0" step="0.01" class="form-control" value="0">
                </div>
                <div class="col-6">
                  <label class="form-label">Currency</label>
                  <input id="currencyInput" type="text" class="form-control" value="₹">
                </div>
              </div>

            </form>

            <div class="mt-3 muted-small">
              <ul>
                <li>Quantity and Price must be positive numbers.</li>
                <li>Discount is percentage per item (0-100).</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Invoice / Output Card -->
        <div class="col-lg-6">
          <div class="card shadow-sm p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="m-0">Invoice Preview</h5>
              <small class="muted-small">Auto-updates when you change items</small>
            </div>

            <div class="table-responsive">
              <table id="invoiceTable" class="table table-sm table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Item</th>
                    <th class="text-end">Qty</th>
                    <th class="text-end">Price</th>
                    <th class="text-end desktop-only">Discount %</th>
                    <th class="text-end">Total</th>
                    <th class="text-center">Action</th>
                  </tr>
                </thead>
                <tbody id="invoiceTbody">
                  <!-- rows -->
                </tbody>
              </table>
            </div>

            <div class="d-flex flex-column gap-2 align-items-end mt-3">
              <div class="w-100 d-flex justify-content-between">
                <div class="muted-small">Subtotal</div>
                <div id="subtotalText">₹ 0.00</div>
              </div>

              <div class="w-100 d-flex justify-content-between">
                <div class="muted-small">Total Discount</div>
                <div id="discountText">₹ 0.00</div>
              </div>

              <div class="w-100 d-flex justify-content-between">
                <div class="muted-small">Tax</div>
                <div id="taxText">₹ 0.00</div>
              </div>

              <hr class="w-100">

              <div class="w-100 d-flex justify-content-between">
                <h5>Total</h5>
                <h5 id="grandTotalText">₹ 0.00</h5>
              </div>

              <div class="w-100 d-flex justify-content-between">
                <button id="exportJsonBtn" class="btn btn-outline-secondary btn-sm">Export JSON</button>
                <div class="text-end">
                  <button id="loadLastBtn" class="btn btn-sm btn-outline-info me-2">Load Last Saved</button>
                  <button id="downloadPdfBtn" class="btn btn-sm btn-primary">Save / Print</button>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="col-12 text-center muted-small">
          Tip: Click a numeric cell to edit quickly — then press Recalculate.
        </div>
      </div>
    </div>

    <!-- Template for item row -->
    <template id="itemTemplate">
      <div class="item-row row g-2 align-items-center mb-2">
        <div class="col-5">
          <input name="name" type="text" class="form-control nameInput" placeholder="Item name" required>
        </div>
        <div class="col-2">
          <input name="qty" type="number" min="1" step="1" class="form-control qtyInput" value="1" required>
        </div>
        <div class="col-2">
          <input name="price" type="number" min="0.01" step="0.01" class="form-control priceInput" value="0.00" required>
        </div>
        <div class="col-2 desktop-only">
          <input name="discount" type="number" min="0" max="100" step="0.01" class="form-control discountInput" value="0">
        </div>
        <div class="col-1 text-end">
          <div class="fw-semibold totalItem">₹ 0.00</div>
        </div>
        <div class="col-12 mt-1">
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-sm btn-outline-danger removeItemBtn">Remove</button>
            <button type="button" class="btn btn-sm btn-outline-secondary collapseBtn">Toggle Discount</button>
          </div>
          <div class="collapse discountCollapse mt-2">
            <label class="form-label small mb-1">Discount (%)</label>
            <input name="discountMobile" type="number" min="0" max="100" step="0.01" class="form-control discountMobileInput" value="0">
          </div>
        </div>
      </div>
    </template>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Utility formatting
      const fmt = (n, cur) => (cur || document.getElementById('currencyInput').value || '₹') + ' ' + Number(n || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

      // App state
      const state = { items: [] };

      // DOM refs
      const itemsContainer = document.getElementById('itemsContainer');
      const itemTemplate = document.getElementById('itemTemplate');
      const invoiceTbody = document.getElementById('invoiceTbody');
      const subtotalText = document.getElementById('subtotalText');
      const discountText = document.getElementById('discountText');
      const taxText = document.getElementById('taxText');
      const grandTotalText = document.getElementById('grandTotalText');
      const taxInput = document.getElementById('taxInput');

      // Create a new empty item and render
      function addItem(data){
        const clone = itemTemplate.content.cloneNode(true);
        const wrapper = clone.querySelector('.item-row');

        // fill defaults
        wrapper.querySelector('.nameInput').value = data?.name || '';
        wrapper.querySelector('.qtyInput').value = data?.qty ?? 1;
        wrapper.querySelector('.priceInput').value = data?.price ?? 0.00;
        wrapper.querySelector('.discountInput').value = data?.discount ?? 0;
        wrapper.querySelector('.discountMobileInput').value = data?.discount ?? 0;
        wrapper.querySelector('.totalItem').textContent = fmt(0);

        // events
        wrapper.querySelector('.removeItemBtn').addEventListener('click', ()=>{ wrapper.remove(); recalc(); });
        wrapper.querySelector('.collapseBtn').addEventListener('click', ()=>{ const c = wrapper.querySelector('.discountCollapse'); const bs = new bootstrap.Collapse(c, {toggle:true}); });

        // Sync desktop/mobile discount inputs
        const dDesktop = wrapper.querySelector('.discountInput');
        const dMobile = wrapper.querySelector('.discountMobileInput');
        dDesktop.addEventListener('input', ()=>{ dMobile.value = dDesktop.value; });
        dMobile.addEventListener('input', ()=>{ dDesktop.value = dMobile.value; });

        // Live validate and update total display on inputs
        ['input','change'].forEach(ev=>{
          wrapper.querySelectorAll('.nameInput,.qtyInput,.priceInput,.discountInput,.discountMobileInput').forEach(el=>{
            el.addEventListener(ev, ()=>{ smallValidate(el); quickRecalcRow(wrapper); });
          });
        });

        itemsContainer.appendChild(wrapper);
        recalc();
      }

      function smallValidate(el){
        // Basic validation for numeric fields
        if(el.classList.contains('qtyInput')){
          if(Number(el.value) <= 0){ el.classList.add('is-invalid'); } else el.classList.remove('is-invalid');
        }
        if(el.classList.contains('priceInput')){
          if(Number(el.value) <= 0){ el.classList.add('is-invalid'); } else el.classList.remove('is-invalid');
        }
        if(el.classList.contains('discountInput') || el.classList.contains('discountMobileInput')){
          if(Number(el.value) < 0 || Number(el.value) > 100) el.classList.add('is-invalid'); else el.classList.remove('is-invalid');
        }
      }

      // Calculate single row and update its display
      function quickRecalcRow(wrapper){
        const name = wrapper.querySelector('.nameInput').value.trim();
        const qty = Number(wrapper.querySelector('.qtyInput').value || 0);
        const price = Number(wrapper.querySelector('.priceInput').value || 0);
        const discountPct = Number(wrapper.querySelector('.discountInput').value || 0);

        // validation
        if(qty <= 0 || price <= 0 || discountPct < 0 || discountPct > 100){
          wrapper.querySelector('.totalItem').textContent = fmt(0);
          return;
        }

        const lineTotal = qty * price;
        const discountAmount = (discountPct/100) * lineTotal;
        const final = lineTotal - discountAmount;
        wrapper.querySelector('.totalItem').textContent = fmt(final);
      }

      // Full recalculation and preview building
      function recalc(){
        const rows = Array.from(itemsContainer.querySelectorAll('.item-row'));
        const items = [];
        let subtotal = 0, totalDiscount = 0;

        rows.forEach(r=>{
          const name = r.querySelector('.nameInput').value.trim();
          const qty = Number(r.querySelector('.qtyInput').value || 0);
          const price = Number(r.querySelector('.priceInput').value || 0);
          const discountPct = Number(r.querySelector('.discountInput').value || 0);

          // Enforce constraints
          if(qty <= 0 || price <= 0){ smallValidate(r.querySelector('.qtyInput')); smallValidate(r.querySelector('.priceInput')); }
          if(discountPct < 0) r.querySelector('.discountInput').value = 0;
          if(discountPct > 100) r.querySelector('.discountInput').value = 100;

          const lineTotal = qty * price;
          const discountAmount = Math.min((discountPct/100) * lineTotal, lineTotal);
          const final = Math.max(lineTotal - discountAmount, 0);

          items.push({name, qty, price, discountPct, lineTotal, discountAmount, final});
          subtotal += lineTotal;
          totalDiscount += discountAmount;
        });

        // taxes
        const taxPct = Number(taxInput.value || 0);
        const taxable = Math.max(subtotal - totalDiscount, 0);
        const taxAmount = (taxPct/100) * taxable;
        const grandTotal = Math.max(taxable + taxAmount, 0);

        // Update preview table
        invoiceTbody.innerHTML = '';
        const cur = document.getElementById('currencyInput').value || '₹';
        items.forEach(it=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(it.name || '—')}</td>
            <td class="text-end">${it.qty}</td>
            <td class="text-end">${cur} ${Number(it.price).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
            <td class="text-end desktop-only">${it.discountPct}%</td>
            <td class="text-end">${cur} ${Number(it.final).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
            <td class="text-center"><button class='btn btn-sm btn-outline-secondary editRowBtn'>Edit</button></td>
          `;
          invoiceTbody.appendChild(tr);
        });

        subtotalText.textContent = fmt(subtotal, cur);
        discountText.textContent = fmt(totalDiscount, cur);
        taxText.textContent = fmt(taxAmount, cur);
        grandTotalText.textContent = fmt(grandTotal, cur);

        // attach edit handlers
        invoiceTbody.querySelectorAll('.editRowBtn').forEach((btn, idx)=>{
          btn.addEventListener('click', ()=>{
            // Scroll to and highlight the input row
            const row = itemsContainer.querySelectorAll('.item-row')[idx];
            row.scrollIntoView({behavior:'smooth', block:'center'});
            row.classList.add('border','border-2','border-info');
            setTimeout(()=>row.classList.remove('border','border-2','border-info'), 1200);
          });
        });

        // update state
        state.items = items;
        return {items, subtotal, totalDiscount, taxAmount, grandTotal};
      }

      // escape HTML simple
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

      // Reset all inputs and preview
      function resetAll(){
        itemsContainer.innerHTML = '';
        invoiceTbody.innerHTML = '';
        taxInput.value = 0; document.getElementById('currencyInput').value = '₹';
        subtotalText.textContent = fmt(0);
        discountText.textContent = fmt(0);
        taxText.textContent = fmt(0);
        grandTotalText.textContent = fmt(0);
        // add one empty row
        addItem();
      }

      // Save to localStorage
      function saveToLocal(){
        const data = recalc();
        const payload = {meta:{savedAt:new Date().toISOString(), taxPct:Number(taxInput.value||0), currency:document.getElementById('currencyInput').value}, items: state.items, totals: {subtotal:data.subtotal, discount:data.totalDiscount, tax:data.taxAmount, grand:data.grandTotal}};
        localStorage.setItem('savedInvoice', JSON.stringify(payload));
        alert('Saved to localStorage (key: savedInvoice)');
      }

      // Load last saved
      function loadLastSaved(){
        const raw = localStorage.getItem('savedInvoice');
        if(!raw){ alert('No saved invoice found'); return; }
        const payload = JSON.parse(raw);
        // build items
        itemsContainer.innerHTML = '';
        payload.items.forEach(it=> addItem({name:it.name, qty:it.qty, price:it.price, discount:it.discountPct}));
        taxInput.value = payload.meta?.taxPct ?? 0;
        document.getElementById('currencyInput').value = payload.meta?.currency ?? '₹';
        recalc();
      }

      // Export JSON file
      function exportJson(){
        const data = recalc();
        const payload = {meta:{exportedAt:new Date().toISOString(), taxPct:Number(taxInput.value||0), currency:document.getElementById('currencyInput').value}, items: state.items, totals: {subtotal:data.subtotal, discount:data.totalDiscount, tax:data.taxAmount, grand:data.grandTotal}};
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'invoice.json'; a.click(); URL.revokeObjectURL(url);
      }

      // Print / save PDF
      function printInvoice(){
        // Open a new window and render a printable invoice
        const data = recalc();
        const cur = document.getElementById('currencyInput').value || '₹';
        const win = window.open('','','width=900,height=700');
        const doc = win.document;
        doc.write('<!doctype html><html><head><title>Invoice</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">');
        doc.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">');
        doc.write('<style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th,td{padding:6px;border-bottom:1px solid #ddd}</style>');
        doc.write('</head><body>');
        doc.write('<h3>Invoice</h3>');
        doc.write('<table class="table table-sm"><thead><tr><th>Item</th><th class="text-end">Qty</th><th class="text-end">Price</th><th class="text-end">Discount</th><th class="text-end">Total</th></tr></thead><tbody>');
        state.items.forEach(it=>{ doc.write(`<tr><td>${escapeHtml(it.name||'—')}</td><td class="text-end">${it.qty}</td><td class="text-end">${cur} ${Number(it.price).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td><td class="text-end">${it.discountPct}%</td><td class="text-end">${cur} ${Number(it.final).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr>`); });
        doc.write('</tbody></table>');
        doc.write(`<div style="text-align:right"> <div>Subtotal: <strong>${fmt(data.subtotal, cur)}</strong></div> <div>Total Discount: <strong>${fmt(data.totalDiscount, cur)}</strong></div> <div>Tax: <strong>${fmt(data.taxAmount, cur)}</strong></div> <h4>Grand Total: <strong>${fmt(data.grandTotal, cur)}</strong></h4></div>`);
       
        doc.write('</body></html>');
        doc.close();
      }

      // Attach main handlers
      document.getElementById('addItemBtn').addEventListener('click', ()=> addItem());
      document.getElementById('calcBtn').addEventListener('click', ()=> recalc());
      document.getElementById('btnReset').addEventListener('click', ()=>{ if(confirm('Clear everything and start a new invoice?')) resetAll(); });
      document.getElementById('btnSaveLocal').addEventListener('click', saveToLocal);
      document.getElementById('loadLastBtn').addEventListener('click', loadLastSaved);
      document.getElementById('exportJsonBtn').addEventListener('click', exportJson);
      document.getElementById('downloadPdfBtn').addEventListener('click', printInvoice);
      document.getElementById('printBtn').addEventListener('click', printInvoice);

      // Initialize with one row
      resetAll();
    </script>
  </body>
</html>